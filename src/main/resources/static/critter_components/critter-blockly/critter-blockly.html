<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../critter-level-mixin/critter-level-mixin.html">


<!--
# critter-blockly

Displays the Efficiencylable for tires of the class c1 (car) according to the EU-guideline for .

## Example
```html
<critter-blockly width="200" height="200" toolbox="[String Toolbox]"></critter-blockly>
```

@demo
-->

<dom-module id="critter-blockly">
  <template>
    <style>
      :host {
        display: block;
      }

      iframe {
        border: none;
        width: 100%;
      }

      #heading{
        width: 100%;
        text-align: center;
      }
    </style>
    <div id="heading">
      <slot></slot>
    </div>
    <iframe id="blockly_frame" src$="[[importPath]]iFrame/blockly_frame.html" height$="{{height}}px"></iframe>
  </template>
  <script>
    class CritterBlockly extends CritterMixins.Level(Polymer.Element) {
      static get is() {
        return 'critter-blockly';
      }

      static get properties() {

        return {

          width: {
            type: Number,
            value: 200
          },

          height: {
            type: Number,
            value: 200
          },

          toolbox: {
            type: String,
            value: '',
            observer: '_toolboxChanged'
          },

          trashcan: {
            type: Boolean,
            value: false,
            observer: '_trashcanChanged'
          },

          controls: {
            type: Boolean,
            value: false,
            observer: '_controlsChanged'
          },

          jsCode: {},

          code: {
            type: String,
            value: '',
            observer: '_codeChanged'
          },

          cut: {
            type: Boolean,
            value: false
          },

          init: {
              type: Boolean,
              value: false
          },

          readOnly: {
              type: Boolean,
              value: false,
            observer: '_readOnlyChanged'
          },

          generator: {
              type: Boolean,
              value: false
          }

        };
      }

      static get observers() {
        return []
      }

      connectedCallback() {
        super.connectedCallback();

        Polymer.RenderStatus.afterNextRender(this, function () {
          let rootNode = window.Core.GameRoot;
          this.$.blockly_frame.addEventListener("load", () => this._updateIFrame());
          rootNode.addEventListener("_levelNameUpdated", this._updateLevelData.bind(this));
          this._globalData = window.Core.CritterLevelData;
        });
      }

      /** updates the IFrame **/
      _updateIFrame() {
        this._toolboxChanged();
        this._controlsChanged();
        this._trashcanChanged();
        this._codeChanged();
        this._readOnlyChanged();
      }

        /** updates the toolbox of the IFrame **/
        _toolboxChanged() {
        if (this.$.blockly_frame.contentWindow.setToolbox) {
          this.$.blockly_frame.contentWindow.setToolbox(this.toolbox);
        }
      }

        /** updates the trashcan symbol of the IFrame **/
        _trashcanChanged() {
        if (this.$.blockly_frame.contentWindow.setTrashcan) {
          this.$.blockly_frame.contentWindow.setTrashcan(this.trashcan);
        }
      }

        /** updates the controls of the IFrame **/
        _controlsChanged() {
            if (this.$.blockly_frame.contentWindow.setControls) {
                this.$.blockly_frame.contentWindow.setControls(this.controls);
            }
        }

        /** updates the code of the IFrame **/
        _codeChanged() {
        if (this.$.blockly_frame.contentWindow.setCode) {
          this.$.blockly_frame.contentWindow.setCode(this.code);
        }
      }

        /** disables changing the blockly code **/
        _readOnlyChanged() {
            if (this.$.blockly_frame.contentWindow.setReadOnly) {
                this.$.blockly_frame.contentWindow.setReadOnly(this.readOnly);
            }
        }

        /** generates JavaScript **/
        getJavaScript() {
        if (this.$.blockly_frame.contentWindow.getCode) {
          this.jsCode = this.$.blockly_frame.contentWindow.getCode();
          return this.jsCode;
        }
      }

        /** generates XML **/
        getXML() {
          if (this.$.blockly_frame.contentWindow.getCode) {
              this.jsCode = this.$.blockly_frame.contentWindow.getXML();
              return this.jsCode;
          }
        }


            /** performs an ajax call to get CUT **/
      _getCUT() {
        let req = document.createElement('iron-ajax');
        req.url = "/level/CUT";
        req.method = "GET";
        req.handleAs = 'text';
        req.contentType = 'application/json';
        req.bubbles = true;
        req.rejectWithRequest = true;
        req.params = {level: this._globalData.levelName};

        req.addEventListener('response', e => {
          this.code = e.detail.__data.response;
        });

        req.generateRequest();
      }

      /** performs an ajax call to get Toolbox for tests and Demo Test **/
      _getTest() {
            let req = document.createElement('iron-ajax');
            req.url = "/level/test";
            req.method = "GET";
            req.handleAs = 'json';
            req.contentType = 'application/json';
            req.bubbles = true;
            req.rejectWithRequest = true;
            req.params = {level: this._globalData.levelName};

            req.addEventListener('response', e => {
                let data = e.detail.__data.response;
                this.code = data.code;
                this.toolbox = data.toolbox;
            });

            req.generateRequest();

        }

        /** performs an ajax call to get the initialize code **/
        _getInit() {
            let req = document.createElement('iron-ajax');
            req.url = "/level/init";
            req.method = "GET";
            req.handleAs = 'text';
            req.contentType = 'application/json';
            req.bubbles = true;
            req.rejectWithRequest = true;
            req.params = {level: this._globalData.levelName};

            req.addEventListener('response', e => {
                this.code = e.detail.__data.response;
            });

            req.generateRequest();

        }

        _getFullToolBox() {
            let req = document.createElement('iron-ajax');
            req.url = "/generator/toolbox";
            req.method = "GET";
            req.handleAs = 'text';
            req.contentType = 'application/json';
            req.bubbles = true;
            req.rejectWithRequest = true;

            req.addEventListener('response', e => {
                this.toolbox = e.detail.__data.response;
            });
            req.generateRequest();

        }

      /** get required data from server **/
      _updateLevelData() {
          if(this.generator){
              this._getFullToolBox();
          }
          else if (this._globalData.levelName !== '') {
            if (this.cut) {
                this._getCUT();
            } else if(this.init){
                this._getInit();
            } else {
                this._getTest();
            }
          }
        }

    }

    window.customElements.define(CritterBlockly.is, CritterBlockly)
  </script>
</dom-module>
